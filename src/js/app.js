// firebase
//const db = firebase.database();
//const auth = firebase.auth();

const quizs = [
    {
        slug: "khmer-history-in-grade-12",
        name: "សំនួរប្រវត្តសាស្ត្រខ្មែរថ្នាក់ទី១២",
        questions: [
            {
                question: "What does HTML stand for?",
                answers: [{
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }
        ]
    },
    {
        slug: "physics-in-grade-12",
        name: "សំនួររូបវិទ្យាថ្នាក់ទី១២",
        questions: [
            {
                question: "What does HTML stand for?",
                answers: [{
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }
        ]
    },
    {
        slug: "biology-in-grade-12",
        name: "សំនួរជីវរិទ្យាថ្នាក់ទី១២",
        questions: [
            {
                question: "What does HTML stand for?",
                answers: [{
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }, {
                question: "What does JS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }, {
                    name: "Wrong",
                    correct: false
                }]
            }, {
                question: "What does CSS stand for?",
                answers: [{
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Wrong",
                    correct: false
                }, {
                    name: "Correct",
                    correct: true
                }]
            }
        ]
    }
];

// initialized elements
const _quizs = document.getElementById("quizs");
const _start = document.getElementById("start");
const _quiz = document.getElementById("quiz");
const _question = document.getElementById("question");
const _choices = document.getElementById("choices");
const _counter = document.getElementById("counter");
const _btimeGauge = document.getElementById("btimeGauge");
const _timeGauge = document.getElementById("timeGauge");
const _progress = document.getElementById("progress");
const _scoreDiv = document.getElementById("scoreContainer");
const _signInWithGoogle = document.getElementById("sign-in-with-google");

// initialized times
const questionTime = 10; // 10s
const gaugeWidth = 100; // 100%
const gaugeUnit = gaugeWidth / questionTime;

// Initialized variables
let lastQuestion = 0;
let runningQuestion = 0;
let count = 0;
let TIMER;
let score = 0;
let questions = [];
let rendomQuestions = [];

// authentication
const signInWithGoogle = () => {
    // Sign into Firebase using popup auth & Google as the identity provider.
    var provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
}

const signOut = () => {
    // Sign out of Firebase.
    auth.signOut();
}

const initFirebaseAuth = () => {
    // Listen to auth state changes.
    auth.onAuthStateChanged(authStateObserver);
}

// Returns the signed-in user's profile pic URL.
const getProfilePicUrl = () => {
    return auth.currentUser.photoURL || '/images/profile_placeholder.png';
}

// Returns the signed-in user's display name.
const getUserName = () => {
    return auth.currentUser.displayName;
}

// Returns true if a user is signed-in.
const isUserSignedIn = () => {
    return !!auth.currentUser;
}

// List all quizs
const listQuizs = () => {
    for (let i = 0; i < quizs.length; i++) {
        _quizs.innerHTML += `<button id="${quizs[i].slug}" data-index-number="${i}" onclick="startQuiz(this.id)">${quizs[i].name}</button>`;
    }
}

// Start quizs
const startQuiz = (id) => {
    if (!id || !quizs) return;

    const $thisQuiz = document.querySelector(`#${id}`);
    const indexNumber = $thisQuiz.dataset.indexNumber;
    const quizName = quizs[indexNumber].name;
    questions = getRandomArray(quizs[indexNumber].questions);

    lastQuestion = questions.length - 1;
    _quizs.style.display = "none";
    renderQuestion();
    _quiz.style.display = "block";
    renderProgress();
    renderCounter();
    TIMER = setInterval(renderCounter, 1000); // 1000ms = 1s
}

// Get new array of question after random
const getRandomArray = (arr) => {
    if (!arr) return;

    let tmp, current, top = arr.length;
    while (--top) {
        current = Math.floor(Math.random() * (top + 1));
        tmp = arr[current];
        arr[current] = arr[top];
        arr[top] = tmp;
    }
    return arr;
}

// render a question
const renderQuestion = () => {
    let q = questions[runningQuestion];
    let refreshAnswers = getRandomArray(q.answers);
    _choices.innerHTML = "";
    _question.innerHTML = "<p>" + q.question + "</p>";
    for (let qA = 0; qA < refreshAnswers.length; qA++) {
        _choices.innerHTML += `<p class="choice" onclick="checkAnswer('${refreshAnswers[qA].name}')">` + refreshAnswers[qA].name + "</p>";
    }
}

// render progress
const renderProgress = () => {
    for (let qIndex = 0; qIndex <= lastQuestion; qIndex++) {
        _progress.innerHTML += `<div class="prog"><span id="${qIndex}">${(qIndex + 1)}</span></div>`;
    }
}

// counter render
const renderCounter = () => {
    if (count <= questionTime) {
        _btimeGauge.style.width = gaugeWidth + "%";
        _counter.innerHTML = count;
        _timeGauge.style.width = count * gaugeUnit + "%";
        count++;
    } else {
        count = 0;
        // change progress color to red
        answerIsWrong();
        if (runningQuestion < lastQuestion) {
            runningQuestion++;
            renderQuestion();
        } else {
            // end the quiz and show the score
            clearInterval(TIMER);
            scoreRender();
        }
    }
}

// checkAnwer

const checkAnswer = (answer) => {
    const result = questions[runningQuestion].answers.find(({ name }) => name === answer);

    if (result.correct == true) {
        // answer is correct
        score++;
        // change progress color to green
        answerIsCorrect();
    } else {
        // answer is wrong
        // change progress color to red
        answerIsWrong();
    }
    count = 0;
    if (runningQuestion < lastQuestion) {
        runningQuestion++;
        renderQuestion();
    } else {
        // end the quiz and show the score
        clearInterval(TIMER);
        scoreRender();
    }
}

// answer is correct
const answerIsCorrect = () => {
    document.getElementById(runningQuestion).style.backgroundColor = "#0f0";
}

// answer is Wrong
const answerIsWrong = () => {
    document.getElementById(runningQuestion).style.backgroundColor = "#f00";
}

// score render
const scoreRender = () => {
    _scoreDiv.style.display = "block";

    // calculate the amount of question percent answered by the user
    const scorePerCent = Math.round(100 * score / questions.length);

    // choose the image based on the scorePerCent
    let img = (scorePerCent >= 80) ? "img/5.png" :
        (scorePerCent >= 60) ? "img/4.png" :
            (scorePerCent >= 40) ? "img/3.png" :
                (scorePerCent >= 20) ? "img/2.png" :
                    "img/1.png";

    _scoreDiv.innerHTML = `<img src="${img}" title="" alt="">`;
    _scoreDiv.innerHTML += `<p id="score">${scorePerCent}% Corrected</p>`;
    _scoreDiv.innerHTML += `<p onclick="window.location.reload();" class="restart">Restart</p>`;
}

_start.addEventListener("click", () => {
    _start.style.display = "none";
    _quizs.style.display = "flex";
    listQuizs();
});

// _signInWithGoogle.addEventListener("click", () => {
//     signInWithGoogle();
// })
